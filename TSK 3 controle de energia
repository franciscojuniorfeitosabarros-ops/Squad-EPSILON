const readline = require("readline");

// =============== LISTA DE M√âDICOS =============== //
class DoctorDirectory {
    constructor() {
        this.doctors = [
            { name: "Dr. Carlos", specialty: "Cardiologista", keywords: ["cora√ß√£o", "dor no peito", "press√£o", "infarto"] },
            { name: "Dr. Ana", specialty: "Neurologista", keywords: ["cabe√ßa", "enxaqueca", "convuls√£o", "nervos", "dor de cabe√ßa"] },
            { name: "Dr. Silva", specialty: "Ortopedista", keywords: ["osso", "fratura", "dor no joelho", "coluna", "tor√ß√£o"] },
            { name: "Dra. Beatriz", specialty: "Pediatra", keywords: ["crian√ßa", "beb√™", "febre infantil", "consulta infantil"] },
            { name: "Dr. Jo√£o", specialty: "Cl√≠nico Geral", keywords: ["febre", "dor", "mal estar", "cansa√ßo", "fraqueza"] },
            { name: "Dr. Ricardo", specialty: "Cirurgi√£o", keywords: ["cirurgia", "opera√ß√£o", "bisturi", "procedimento cir√∫rgico"] }
        ];
    }

    findDoctorBySituation(situation) {
        const s = situation.toLowerCase();
        for (let doc of this.doctors) {
            for (let key of doc.keywords) {
                if (s.includes(key)) {
                    console.log(\nüîç M√©dico recomendado: ${doc.name} (${doc.specialty}));
                    return;
                }
            }
        }
        console.log("\n‚ö† Nenhum m√©dico encontrado especificamente. Recomenda√ß√£o padr√£o: Cl√≠nico Geral (Dr. Jo√£o)");
    }

    listDoctors() {
        console.log("\n M√âDICOS DISPON√çVEIS:");
        this.doctors.forEach((d, i) => console.log(${i+1}. ${d.name} - ${d.specialty}));
    }
}

const directory = new DoctorDirectory();

// =============== PRONTU√ÅRIO (LinkedList) =============== //
class ConsultationNode {
    constructor(date, time, doctor, diagnosis) {
        this.date = date;
        this.time = time;
        this.doctor = doctor;
        this.diagnosis = diagnosis;
        this.next = null;
    }
}

class MedicalHistory {
    constructor() {
        this.head = null;
    }

    addConsultation(date, time, doctor, diagnosis) {
        const newNode = new ConsultationNode(date, time, doctor, diagnosis);
        if (!this.head) {
            this.head = newNode;
            return;
        }
        let curr = this.head;
        while (curr.next) curr = curr.next;
        curr.next = newNode;
    }

    printHistory() {
        if (!this.head) {
            console.log("\n‚ö† Nenhuma consulta no prontu√°rio.");
            return;
        }
        console.log("\n HIST√ìRICO M√âDICO DO PACIENTE:");
        let curr = this.head, i = 1;
        while (curr) {
            console.log(\nConsulta #${i});
            console.log( Data: ${curr.date});
            console.log( Hora: ${curr.time});
            console.log( M√©dico: ${curr.doctor});
            console.log( Diagn√≥stico: ${curr.diagnosis});
            curr = curr.next;
            i++;
        }
    }

    clearHistory() {
        this.head = null;
        console.log("\nüóë Hist√≥rico apagado com sucesso!");
    }
}

const history = new MedicalHistory();

// =============== FILA DE TRIAGEM (FIFO) =============== //
class TriageQueue {
    constructor() {
        this.queue = [];
    }
    enqueue(p) { this.queue.push(p); }
    dequeue() { return this.queue.shift(); }
    show() {
        if (!this.queue.length) {
            console.log("\n Fila de triagem vazia.");
            return;
        }
        console.log("\nüöë FILA DE TRIAGEM:");
        this.queue.forEach((n, i) => console.log(${i+1}. ${n}));
    }
}

const triage = new TriageQueue();

// =============== PILHA DE CIRURGIA =============== //
class SurgeryStack {
    constructor() {
        this.surgeryMap = new Map(); // paciente ‚Üí pilha
    }

    ensureStack(patient) {
        if (!this.surgeryMap.has(patient)) this.surgeryMap.set(patient, []);
        return this.surgeryMap.get(patient);
    }

    pushStep(patient, step) {
        const st = this.ensureStack(patient);
        st.push(step);
        console.log(\n Passo "${step}" registrado para ${patient});
    }

    undoStep(patient) {
        const st = this.ensureStack(patient);
        if (!st.length) console.log(\n‚ö† Nenhum passo para desfazer na cirurgia de ${patient});
        else console.log(\n‚Ü© Desfeito: ${st.pop()});
    }

    showChecklist(patient) {
        const st = this.ensureStack(patient);
        if (!st.length) console.log(\n Nenhum passo registrado na cirurgia de ${patient});
        else {
            console.log(\n CHECKLIST CIR√öRGICO DE ${patient} (Topo ‚Üí Base):);
            for (let i = st.length-1; i >= 0; i--) console.log(- ${st[i]});
        }
    }
}

const surgery = new SurgeryStack();

// =============== INTERFACE DO MENU =============== //
const rl = readline.createInterface({ input: process.stdin, output: process.stdout });

function menu() {
    console.log(`
================== SISTEMA HOSPITALAR (HIS + Telemedicina) ==================

 PRONTU√ÅRIO
1 - Adicionar consulta ao prontu√°rio
2 - Mostrar hist√≥rico do paciente
3 - Apagar hist√≥rico do prontu√°rio

 TRIAGEM INICIAL
4 - Chegar paciente na recep√ß√£o
5 - Atender pr√≥ximo paciente da triagem
6 - Mostrar fila de triagem

 CIRURGIAS - CHECKLIST
7 - Registrar passo da cirurgia do paciente
8 - Desfazer √∫ltimo passo da cirurgia do paciente
9 - Mostrar checklist da cirurgia do paciente

 ENCONTRAR DOUTOR ADEQUADO
10 - Buscar doutor ideal para situa√ß√£o atual do paciente

0 - Sair
========================================================================== 
`);

    rl.question("Escolha uma op√ß√£o: ", (op) => {
        switch(op) {
            case "1":
                rl.question("Paciente: ", (p) => {
                    rl.question("Data (DD-MM-YYYY): ", (date) => {
                        rl.question("Hora (HH:MM): ", (time) => {
                            rl.question("M√©dico: ", (doc) => {
                                rl.question("Diagn√≥stico: ", (diag) => {
                                    history.addConsultation(${p} | ${date}, time, doc, diag);
                                    menu();
                                });
                            });
                        });
                    });
                });
                break;

            case "2": history.printHistory(); menu(); break;
            case "3": history.clearHistory(); menu(); break;
            case "4":
                rl.question("Nome do paciente: ", (n) => {
                    triage.enqueue(n);
                    console.log(\nüöë Paciente "${n}" entrou na triagem.);
                    menu();
                });
                break;
            case "5":
                const next = triage.dequeue();
                console.log(next ? \n Atendendo: ${next} : "\n‚ö† Fila vazia.");
                menu();
                break;
            case "6": triage.show(); menu(); break;
            case "7":
                rl.question("Paciente da cirurgia: ", (p) => {
                    rl.question("Passo do procedimento: ", (s) => {
                        surgery.pushStep(p, s);
                        menu();
                    });
                });
                break;
            case "8":
                rl.question("Paciente para desfazer passo: ", (p) => {
                    surgery.undoStep(p);
                    menu();
                });
                break;
            case "9":
                rl.question("Paciente para ver checklist: ", (p) => {
                    surgery.showChecklist(p);
                    menu();
                });
                break;

            case "10":
                rl.question("Descreva a situa√ß√£o atual do paciente: ", (sit) => {
                    directory.findDoctorBySituation(sit);
                    menu();
                });
                break;

            case "0":
                console.log("\n Sistema encerrado!");
                rl.close();
                break;

            default:
                console.log("\n Op√ß√£o inv√°lida.");
                menu();
        }
    });
}

menu();
