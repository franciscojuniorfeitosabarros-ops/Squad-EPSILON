const readline = require("readline");

// =============== LISTA DE MÃ‰DICOS =============== //
class DoctorDirectory {
    constructor() {
        this.doctors = [
            { name: "Dr. Carlos", specialty: "Cardiologista", keywords: ["coraÃ§Ã£o", "dor no peito", "pressÃ£o", "infarto"] },
            { name: "Dr. Ana", specialty: "Neurologista", keywords: ["cabeÃ§a", "enxaqueca", "convulsÃ£o", "nervos", "dor de cabeÃ§a"] },
            { name: "Dr. Silva", specialty: "Ortopedista", keywords: ["osso", "fratura", "joelho", "coluna", "torÃ§Ã£o"] },
            { name: "Dra. Beatriz", specialty: "Pediatra", keywords: ["crianÃ§a", "bebÃª", "febre infantil"] },
            { name: "Dr. JoÃ£o", specialty: "ClÃ­nico Geral", keywords: ["febre", "mal estar", "cansaÃ§o", "fraqueza"] },
            { name: "Dr. Ricardo", specialty: "CirurgiÃ£o", keywords: ["cirurgia", "operaÃ§Ã£o", "procedimento"] }
        ];
    }

    findDoctorBySituation(situation) {
        const s = situation.toLowerCase();
        for (let doc of this.doctors) {
            for (let key of doc.keywords) {
                if (s.includes(key)) {
                    console.log(\nğŸ‘¨â€âš• MÃ©dico recomendado: ${doc.name} (${doc.specialty}));
                    return;
                }
            }
        }
        console.log("\nâš  Nenhum mÃ©dico especÃ­fico encontrado. Recomendado: ClÃ­nico Geral (Dr. JoÃ£o)");
    }

    listDoctors() {
        console.log("\nğŸ‘¨â€âš• LISTA DE MÃ‰DICOS:");
        this.doctors.forEach((d, i) => console.log(${i+1}. ${d.name} - ${d.specialty}));
    }
}

const directory = new DoctorDirectory();

// =============== PRONTUÃRIO (LinkedList) =============== //
class ConsultationNode {
    constructor(patient, date, time, doctor, diagnosis) {
        this.patient = patient;
        this.date = date;
        this.time = time;
        this.doctor = doctor;
        this.diagnosis = diagnosis;
        this.next = null;
    }
}

class MedicalHistory {
    constructor() {
        this.head = null;
    }

    addConsultation(patient, date, time, doctor, diagnosis) {
        const newNode = new ConsultationNode(patient, date, time, doctor, diagnosis);
        if (!this.head) {
            this.head = newNode;
            return;
        }
        let curr = this.head;
        while (curr.next) curr = curr.next;
        curr.next = newNode;
    }

    printHistory() {
        if (!this.head) {
            console.log("\nâš  ProntuÃ¡rio vazio.");
            return;
        }
        console.log("\nğŸ“˜ HISTÃ“RICO DE CONSULTAS:");
        let curr = this.head, i = 1;
        while (curr) {
            console.log(\nAtendimento #${i});
            console.log(Paciente: ${curr.patient});
            console.log(ğŸ“… Data: ${curr.date}  â° Hora: ${curr.time});
            console.log(ğŸ‘¨â€âš• MÃ©dico: ${curr.doctor});
            console.log(ğŸ“ DiagnÃ³stico: ${curr.diagnosis});
            curr = curr.next;
            i++;
        }
    }

    clearHistory() {
        this.head = null;
        console.log("\nğŸ—‘ Todo histÃ³rico do prontuÃ¡rio foi apagado!");
    }
}

const history = new MedicalHistory();

// =============== FILA TRIAGEM (FIFO) =============== //
class TriageQueue {
    constructor() { this.queue = []; }
    enqueue(p) { this.queue.push(p); }
    dequeue() { return this.queue.shift(); }
    show() {
        if (!this.queue.length) console.log("\nğŸš‘ Fila de triagem vazia.");
        else {
            console.log("\nğŸš‘ FILA DE TRIAGEM:");
            this.queue.forEach((p, i) => console.log(${i+1}. ${p}));
        }
    }
}

const triage = new TriageQueue();

// =============== PILHA CIRURGIAS POR PACIENTE =============== //
class SurgeryStack {
    constructor() { this.map = new Map(); }
    ensureStack(p) { if (!this.map.has(p)) this.map.set(p, []); return this.map.get(p);}
    pushStep(p, step) { this.ensureStack(p).push(step); console.log(\nâœ… Passo registrado para ${p});}
    undoStep(p) {
        const s = this.ensureStack(p);
        if (!s.length) console.log(\nâš  Nenhum passo para desfazer em ${p});
        else console.log(\nâ†© Passo desfeito de ${p}: ${s.pop()});
    }
    showChecklist(p) {
        const s = this.ensureStack(p);
        if (!s.length) console.log(\nğŸ©º Nenhum passo registrado para ${p});
        else {
            console.log(\nğŸ©º CHECKLIST DE ${p} (Topo â†’ Base):);
            for (let i = s.length-1; i>=0; i--) console.log(- ${s[i]});
        }
    }
}
const surgery = new SurgeryStack();

// =============== GESTÃƒO DE LEITOS UTI =============== //
class UtiBedManager {
    constructor() { this.beds = new Array(10).fill(null); }

    assignBed(number, patient) {
        if (number < 0 || number > 9) {
            console.log("\nâš  NÃºmero de leito invÃ¡lido. Escolha 0â€“9");
            return;
        }
        if (this.beds[number] !== null) {
            console.log(\nâŒ Leito ${number} ocupado por ${this.beds[number]});
        } else {
            this.beds[number] = patient;
            console.log(\nğŸ› Leito ${number} atribuÃ­do para ${patient});
        }
    }

    releaseBed(number) {
        if (number < 0 || number > 9) {
            console.log("\nâš  NÃºmero invÃ¡lido. Escolha 0â€“9");
            return;
        }
        if (this.beds[number] === null) {
            console.log(\nâœ… Leito ${number} jÃ¡ estÃ¡ livre.);
        } else {
            console.log(\nâ™» Leito ${number} liberado (Paciente: ${this.beds[number]}));
            this.beds[number] = null;
        }
    }

    checkAvailability() {
        const free = this.beds.filter(b => b === null).length;
        console.log(\nğŸ” Leitos livres: ${free} de 10);
        return free;
    }

    showBeds() {
        console.log("\nğŸ©º STATUS DOS LEITOS DA UTI:");
        this.beds.forEach((b,i) =>
            console.log(Leito ${i}: ${b === null ? "ğŸŸ© Livre" : "ğŸ”´ Ocupado por " + b})
        );
    }
}

const utiManager = new UtiBedManager();

// =============== INTERFACE MENU =============== //
const rl = readline.createInterface({input: process.stdin, output: process.stdout});

function menu() {
    console.log(`
================= SISTEMA HIS =================

ğŸ“˜ PRONTUÃRIO
1 - Adicionar consulta
2 - Mostrar histÃ³rico
3 - Apagar histÃ³rico

ğŸš‘ TRIAGEM
4 - Chegar paciente na recepÃ§Ã£o
5 - Atender prÃ³ximo da triagem
6 - Mostrar fila da triagem

ğŸ¥ CIRURGIAS
7 - Registrar passo da cirurgia do paciente
8 - Desfazer Ãºltimo passo da cirurgia do paciente
9 - Mostrar checklist da cirurgia do paciente

ğŸ‘¨â€âš• MÃ‰DICO
10 - Buscar doutor adequado pela situaÃ§Ã£o

ğŸ› UTI
11 - Atribuir leito da UTI
12 - Liberar leito da UTI
13 - Mostrar status dos leitos da UTI
14 - Contar leitos livres da UTI

0 - Sair
==============================================
`);

    rl.question("OpÃ§Ã£o: ", (op) => {
        switch(op) {
            case "1":
                rl.question("Paciente: ", (p) => {
                    rl.question("Data (DD-MM-YYYY): ", (date) => {
                        rl.question("Hora (HH:MM): ", (time) => {
                            rl.question("MÃ©dico: ", (doc) => {
                                rl.question("DiagnÃ³stico: ", (diag) => {
                                    history.addConsultation(p, date, time, doc, diag);
                                    console.log("\nâœ… Consulta registrada!");
                                    menu();
                                });
                            });
                        });
                    });
                });
                break;
            case "2": history.printHistory(); menu(); break;
            case "3": history.clearHistory(); menu(); break;

            case "4":
                rl.question("Paciente chegando na recepÃ§Ã£o: ", (n) => {
                    if (!n.trim()) console.log("\nâš  Nome invÃ¡lido.");
                    else {
                        triage.enqueue(n);
                        console.log(\nğŸš‘ Paciente "${n}" entrou na fila.);
                    }
                    menu();
                });
                break;
            case "5":
                const t = triage.dequeue();
                console.log(t ? \nğŸ©º Paciente chamado: ${t} : "\nâš  Fila vazia.");
                menu();
                break;
            case "6": triage.show(); menu(); break;

            case "7":
                rl.question("Paciente da cirurgia: ", (p) => {
                    rl.question("Passo do procedimento: ", (s) => {
                        if(!s.trim()) console.log("\nâš  InvÃ¡lido.");
                        else surgery.pushStep(p, s);
                        menu();
                    });
                });
                break;
            case "8":
                rl.question("Paciente para desfazer: ", (p) => {
                    surgery.undoStep(p);
                    menu();
                });
                break;
            case "9":
                rl.question("Paciente para ver checklist: ", (p) => {
                    surgery.showChecklist(p);
                    menu();
                });
                break;

            case "10":
                rl.question("SituaÃ§Ã£o atual / sintomas do paciente: ", (s) => {
                    directory.findDoctorBySituation(s);
                    menu();
                });
                break;

            case "11":
                rl.question("Leito da UTI (0â€“9): ", (num) => {
                    rl.question("Paciente: ", (p) => {
                        utiManager.assignBed(Number(num), p);
                        menu();
                    });
                });
                break;
            case "12":
                rl.question("Leito para liberar (0â€“9): ", (num) => {
                    utiManager.releaseBed(Number(num));
                    menu();
                });
                break;
            case "13": utiManager.showBeds(); menu(); break;
            case "14": utiManager.checkAvailability(); menu(); break;

            case "0":
                console.log("\nğŸ‘‹ Encerrando...");
                rl.close();
                break;
            default:
                console.log("\nâŒ OpÃ§Ã£o invÃ¡lida.");
                menu();
        }
    });
}

menu();
